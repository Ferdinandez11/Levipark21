<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levipark21 - √Årea Cliente</title>
    <link rel="icon" href="data:,">
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #111; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 24px; font-weight: bold; color: #4a90e2; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #aaa; transition: 0.2s; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background: rgba(74, 144, 226, 0.15); color: #fff; }
        .user-profile { margin-top: auto; padding-top: 20px; border-top: 1px solid #333; display: flex; align-items: center; gap: 10px; }
        
        /* Main Content */
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .btn-new { background: #27ae60; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-new:hover { background: #219150; transform: translateY(-2px); }

        /* Grid de Proyectos */
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .project-card { background: #252525; border: 1px solid #333; border-radius: 12px; overflow: hidden; transition: 0.3s; position: relative; }
        .project-card:hover { transform: translateY(-5px); border-color: #4a90e2; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .card-img { height: 160px; background: #333; display: flex; align-items: center; justify-content: center; color: #555; font-size: 40px; background-size: cover; background-position: center; }
        .card-body { padding: 15px; }
        .card-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 12px; color: #888; display: flex; justify-content: space-between; margin-bottom: 15px; }
        .card-actions { display: flex; gap: 10px; }
        .btn-card { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444; background: transparent; color: #ddd; cursor: pointer; font-size: 13px; text-align: center; text-decoration: none; }
        .btn-card:hover { background: #333; color: #fff; }
        .btn-edit { border-color: #4a90e2; color: #4a90e2; }
        .btn-edit:hover { background: #4a90e2; color: white; }

        /* Tablas */
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 10px; border-bottom: 1px solid #444; color: #888; }
        td { padding: 15px; border-bottom: 1px solid #333; }

        /* MODAL SIMPLE */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #222; padding: 25px; border-radius: 8px; width: 400px; border: 1px solid #444; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 13px; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        
        .empty-state { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><span>üèüÔ∏è</span> Levipark Hub</div>
        <a id="nav-projects" class="menu-item active">üìÇ Mis Proyectos</a>
        <a id="nav-orders" class="menu-item">üì¶ Mis Pedidos</a>
        <a id="nav-tickets" class="menu-item">üõ†Ô∏è Incidencias</a>
        
        <div class="user-profile">
            <div style="width: 35px; height: 35px; background: #4a90e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;" id="user-avatar">U</div>
            <div>
                <div style="font-size: 14px; font-weight: bold;" id="user-name">Cargando...</div>
                <div style="font-size: 11px; color: #888; cursor: pointer;" id="btn-logout">Cerrar Sesi√≥n</div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="header">
            <h1 id="page-title">Mis Proyectos</h1>
            <button id="btn-main-action" class="btn-new" onclick="window.location.href='index.html'">‚ûï Nuevo Dise√±o</button>
        </div>

        <!-- SECCI√ìN PROYECTOS -->
        <div id="projects-container" class="projects-grid"></div>

        <!-- SECCI√ìN PEDIDOS -->
        <div id="orders-container" style="display: none;">
            <table>
                <thead><tr><th>Ref</th><th>Proyecto</th><th>Fecha</th><th>Estado</th><th>Total</th><th>Acciones</th></tr></thead>
                <tbody id="orders-list"></tbody>
            </table>
        </div>

        <!-- SECCI√ìN INCIDENCIAS -->
        <div id="tickets-container" style="display: none;">
            <table>
                <thead><tr><th>Ref Pedido</th><th>Tipo</th><th>Descripci√≥n</th><th>Estado</th><th>Fecha</th></tr></thead>
                <tbody id="tickets-list"></tbody>
            </table>
        </div>
    </div>

    <!-- MODAL NUEVA INCIDENCIA -->
    <div id="ticket-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0">Nueva Incidencia</h3>
            <div class="input-group">
                <label>Selecciona el Pedido Afectado</label>
                <select id="ticket-order-select"><option>Cargando pedidos...</option></select>
            </div>
            <div class="input-group">
                <label>Tipo de problema</label>
                <select id="ticket-type">
                    <option value="garantia">üõ°Ô∏è Garant√≠a</option>
                    <option value="rotura">üí• Rotura / Vandalismo</option>
                    <option value="mantenimiento">üîß Mantenimiento</option>
                    <option value="otro">‚ùì Otro</option>
                </select>
            </div>
            <div class="input-group">
                <label>Descripci√≥n del problema</label>
                <textarea id="ticket-desc" rows="4" placeholder="Describe qu√© ha pasado..."></textarea>
            </div>
            <div style="display:flex; justify-content:end; gap:10px;">
                <button onclick="document.getElementById('ticket-modal').style.display='none'" class="btn-card" style="width:auto;">Cancelar</button>
                <button id="btn-submit-ticket" class="btn-new" style="width:auto;">Enviar Reporte</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { SUPABASE_URL, SUPABASE_KEY } from './config.js';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUserId = null;

        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }

            currentUserId = session.user.id;
            const user = session.user;
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            
            const displayName = profile?.company_name || user.email.split('@')[0];
            document.getElementById('user-name').innerText = displayName;
            document.getElementById('user-avatar').innerText = displayName[0].toUpperCase();

            loadProjects(); // Carga inicial

            // LOGICA NAVEGACION
            setupNavigation();

            document.getElementById('btn-logout').onclick = async () => {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            };

            // LOGICA MODAL INCIDENCIAS
            document.getElementById('btn-submit-ticket').onclick = createTicket;
        }

        function setupNavigation() {
            const tabs = {
                'nav-projects': { title: 'Mis Proyectos', container: 'projects-container', actionBtn: '‚ûï Nuevo Dise√±o', action: () => window.location.href='index.html' },
                'nav-orders': { title: 'Mis Pedidos', container: 'orders-container', actionBtn: null },
                'nav-tickets': { title: 'Incidencias', container: 'tickets-container', actionBtn: '‚ûï Nueva Incidencia', action: openTicketModal }
            };

            Object.keys(tabs).forEach(id => {
                document.getElementById(id).onclick = () => {
                    // Reset UI
                    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                    ['projects-container', 'orders-container', 'tickets-container'].forEach(cid => document.getElementById(cid).style.display = 'none');
                    
                    // Activate current
                    document.getElementById(id).classList.add('active');
                    document.getElementById(tabs[id].container).style.display = (id === 'nav-projects' ? 'grid' : 'block');
                    document.getElementById('page-title').innerText = tabs[id].title;
                    
                    const btn = document.getElementById('btn-main-action');
                    if (tabs[id].actionBtn) {
                        btn.style.display = 'flex';
                        btn.innerText = tabs[id].actionBtn;
                        btn.onclick = tabs[id].action;
                    } else {
                        btn.style.display = 'none';
                    }

                    // Load Data
                    if (id === 'nav-projects') loadProjects();
                    if (id === 'nav-orders') loadOrders();
                    if (id === 'nav-tickets') loadTickets();
                };
            });
        }

        // --- CARGA DE DATOS ---

        async function loadProjects() {
            const container = document.getElementById('projects-container');
            container.innerHTML = '<div style="color:#888">Cargando...</div>';
            const { data: projects } = await supabase.from('projects').select('*').order('updated_at', { ascending: false });
            
            container.innerHTML = "";
            if (!projects || projects.length === 0) {
                container.innerHTML = `<div class="empty-state" style="grid-column:1/-1">No hay proyectos.</div>`;
                return;
            }

            projects.forEach(p => {
                const editUrl = `index.html?project_id=${p.id}`;
                const date = new Date(p.updated_at || p.created_at).toLocaleDateString();
                const price = (p.total_price || 0).toLocaleString();
                const timeParam = p.updated_at ? `?t=${new Date(p.updated_at).getTime()}` : '';
                const bgImage = p.thumbnail_url ? `url('${p.thumbnail_url}${timeParam}')` : "url('assets/img/placeholder_park.jpg')";
                
                const html = `
                    <div class="project-card">
                        <div class="card-img" style="background-image: ${bgImage}; background-color:#333;">${p.thumbnail_url?'':'üèûÔ∏è'}</div>
                        <div class="card-body">
                            <div class="card-title">${p.name}</div>
                            <div class="card-meta"><span>üìÖ ${date}</span><span style="color:#4a90e2;font-weight:bold;">${price} ‚Ç¨</span></div>
                            <div class="card-actions">
                                <a href="${editUrl}" class="btn-card btn-edit">‚úèÔ∏è Editar</a>
                                <button class="btn-card" style="background:#e67e22;border-color:#d35400;color:white;" onclick="window.requestQuote('${p.id}','${p.name}',${p.total_price})">üõí Solicitar</button>
                                <button class="btn-card" style="color:#e74c3c;border-color:#552222;flex:0;" onclick="window.deleteProject('${p.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        async function loadOrders() {
            const tbody = document.getElementById('orders-list');
            tbody.innerHTML = '<tr><td colspan="6" style="padding:20px;text-align:center">Cargando...</td></tr>';
            
            // CAMBIO: A√±adimos .eq('user_id', currentUserId)
            // Esto fuerza a que solo traiga MIS pedidos, aunque sea Admin.
            const { data: orders } = await supabase
                .from('orders')
                .select('*, projects(name)')
                .eq('user_id', currentUserId) // <--- FILTRO DE PRIVACIDAD
                .order('created_at', { ascending: false });

            tbody.innerHTML = "";
            if (!orders || orders.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="6" style="padding:40px;text-align:center;color:#666;">Sin pedidos.</td></tr>'; 
                return; 
            }

            orders.forEach(o => {
                let color = '#aaa';
                if(o.status === 'fabricacion') color = '#f1c40f';
                if(o.status === 'enviado') color = '#3498db';
                if(o.status === 'entregado') color = '#27ae60';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${o.order_ref}</strong></td>
                        <td>${o.projects?.name || 'Borrado'}</td>
                        <td>${new Date(o.created_at).toLocaleDateString()}</td>
                        <td><span style="color:${color};border:1px solid ${color};padding:2px 8px;border-radius:10px;font-size:12px;text-transform:uppercase;">${o.status}</span></td>
                        <td>${o.total_price.toLocaleString()} ‚Ç¨</td>
                        <td><button class="btn-card" style="width:auto;padding:5px;">üìÑ Factura</button></td>
                    </tr>`;
            });
        }

        async function loadTickets() {
            const tbody = document.getElementById('tickets-list');
            tbody.innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center">Cargando incidencias...</td></tr>';
            
            // CAMBIO: A√±adimos .eq('user_id', currentUserId)
            const { data: tickets } = await supabase
                .from('tickets')
                .select('*, orders(order_ref)')
                .eq('user_id', currentUserId) // <--- FILTRO DE PRIVACIDAD
                .order('created_at', { ascending: false });

            tbody.innerHTML = "";
            if (!tickets || tickets.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="5" style="padding:40px;text-align:center;color:#666;">No tienes incidencias. üëç</td></tr>'; 
                return; 
            }

            tickets.forEach(t => {
                let color = t.status === 'abierto' ? '#e74c3c' : (t.status === 'resuelto' ? '#27ae60' : '#f1c40f');
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${t.orders?.order_ref || '???'}</strong></td>
                        <td style="text-transform:capitalize">${t.type}</td>
                        <td style="color:#aaa;">${t.description}</td>
                        <td><span style="color:${color}; font-weight:bold;">‚óè ${t.status}</span></td>
                        <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    </tr>`;
            });
        }

        // --- LOGICA DE CREACI√ìN ---

        window.deleteProject = async (id) => {
            if(!confirm("¬øBorrar proyecto?")) return;
            await supabase.from('projects').delete().eq('id', id);
            loadProjects();
        };

        window.requestQuote = async (pid, pname, price) => {
            if(!confirm(`¬øSolicitar presupuesto para "${pname}"?`)) return;
            const ref = 'PED-' + Math.floor(1000 + Math.random() * 9000);
            const { error } = await supabase.from('orders').insert([{ user_id: currentUserId, project_id: pid, order_ref: ref, total_price: price, status: 'pendiente' }]);
            
            if(error) alert(error.message);
            else { alert("¬°Solicitud enviada!"); document.getElementById('nav-orders').click(); }
        };

        async function openTicketModal() {
            const select = document.getElementById('ticket-order-select');
            select.innerHTML = '<option>Cargando...</option>';
            document.getElementById('ticket-modal').style.display = 'flex';

            // Cargar pedidos del usuario para el desplegable
            const { data: orders } = await supabase.from('orders').select('id, order_ref, projects(name)').order('created_at', { ascending: false });
            
            select.innerHTML = "";
            if(!orders || orders.length === 0) {
                select.innerHTML = '<option value="">No tienes pedidos para reclamar</option>';
            } else {
                orders.forEach(o => {
                    const option = document.createElement('option');
                    option.value = o.id;
                    option.innerText = `${o.order_ref} - ${o.projects?.name || 'Parque'}`;
                    select.appendChild(option);
                });
            }
        }

        async function createTicket() {
            const orderId = document.getElementById('ticket-order-select').value;
            const type = document.getElementById('ticket-type').value;
            const desc = document.getElementById('ticket-desc').value;

            if(!orderId) return alert("Debes seleccionar un pedido.");
            if(!desc) return alert("Describe el problema.");

            const { error } = await supabase.from('tickets').insert([{
                user_id: currentUserId,
                order_id: orderId,
                type: type,
                description: desc,
                status: 'abierto'
            }]);

            if(error) alert(error.message);
            else {
                document.getElementById('ticket-modal').style.display = 'none';
                document.getElementById('ticket-desc').value = ""; // Limpiar
                loadTickets(); // Recargar lista
                alert("Incidencia creada correctamente.");
            }
        }

        init();
    </script>
</body>
</html>