<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Levipark21 Platform</title>
    
    <!-- LIBRERÃAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <!-- PANTALLA DE CARGA -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text" style="margin-top:15px; font-weight:bold;">Iniciando...</div>
        <div style="font-size:12px; color:#aaa; margin-top:5px;">Por favor, espera.</div>
    </div>

    <div id="toast-container"></div>

    <!-- MODAL PERSONALIZADO (Input) -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">TÃ­tulo</h3>
            <p id="modal-desc" style="display:none; color:#ccc; font-size:13px; margin-bottom:10px;"></p>
            <input type="text" id="modal-input" class="input-box" style="margin-bottom:15px;">
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn-reset" style="margin:0; width:auto; padding:8px 20px;">Cancelar</button>
                <button id="modal-ok" class="btn-action" style="margin:0; width:auto; background:#27ae60; padding:8px 20px;">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- MODAL QR -->
    <div id="qr-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box qr-content">
            <div class="qr-title">ğŸ“± Ver en Realidad Aumentada</div>
            <div id="qrcode"></div>
            <button class="btn-close-qr" onclick="document.getElementById('qr-modal').style.display='none'">Cerrar</button>
        </div>
    </div>

    <!-- MODAL LOGIN / REGISTRO -->
    <div id="auth-panel" class="modal-overlay" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-box" style="width:300px; text-align:left;">
            <div style="display:flex; justify-content:space-between;">
                <h2>Acceso Clientes</h2>
                <button onclick="document.getElementById('auth-panel').style.display='none'" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">Ã—</button>
            </div>
            
            <div style="margin-bottom:10px;">
                <label class="input-label">Email</label>
                <input type="email" id="auth-email" class="input-box" placeholder="ejemplo@empresa.com">
            </div>
            <div style="margin-bottom:10px;">
                <label class="input-label">ContraseÃ±a</label>
                <input type="password" id="auth-pass" class="input-box" placeholder="********">
            </div>
            <!-- Campo Empresa solo para registro -->
            <div id="register-fields" style="display:none; margin-bottom:10px;">
                <label class="input-label">Nombre Empresa</label>
                <input type="text" id="auth-company" class="input-box" placeholder="Mi Empresa S.L.">
            </div>

            <button id="btn-login-submit" class="btn-action" style="background:#4a90e2; margin-top:10px;">Iniciar SesiÃ³n</button>
            <button id="btn-register-submit" class="btn-action" style="background:#27ae60; margin-top:5px; display:none;">Crear Cuenta</button>
            
            <p style="text-align:center; font-size:12px; margin-top:15px; cursor:pointer; color:#aaa;" id="toggle-auth-mode">
                Â¿No tienes cuenta? <span style="color:#4a90e2; text-decoration:underline;">RegÃ­strate aquÃ­</span>
            </p>
        </div>
    </div>

    <!-- MODAL LISTA PROYECTOS NUBE -->
    <div id="cloud-projects-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="width: 400px; max-width:90%; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">â˜ï¸ Mis Proyectos</h3>
                <button onclick="document.getElementById('cloud-projects-modal').style.display='none'" style="background:none; border:none; color:#aaa; font-size:20px; cursor:pointer;">Ã—</button>
            </div>
            <div id="cloud-list-content" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;">
                <!-- Lista dinÃ¡mica -->
            </div>
        </div>
    </div>

    <div id="btn-toggle-menu">â˜°</div>
    <div id="btn-toggle-env">â˜€</div> 
    
    <!-- BARRA SUPERIOR -->
    <div id="top-bar-controls">
        <button id="btn-snap" class="top-icon-btn" title="Snapping / ImÃ¡n (S)">ğŸ§²</button>
        <button id="btn-toggle-safety" class="top-icon-btn" title="Ver Zonas Seguridad">ğŸ›¡ï¸</button>
        <button id="btn-toggle-grid" class="top-icon-btn" title="Ver CuadrÃ­cula">â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹ğŸ“</button>
    </div>

    <div id="history-controls">
        <button id="btn-undo" title="Deshacer (Ctrl+Z)">â†©</button>
        <button id="btn-redo" title="Rehacer (Ctrl+Y)">â†ª</button>
    </div>

    <!-- PANEL DERECHO (LOGIN + ACCIONES) -->
    <div style="position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; z-index: 100;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <span id="user-label" style="display:none; font-size:12px; color:#fff; font-weight:bold; text-shadow:0 1px 2px black;"></span>
            <button id="btn-auth-trigger" class="btn-mini" style="background:#34495e; padding:8px 15px; font-size:12px; border:1px solid #555; box-shadow:0 4px 6px rgba(0,0,0,0.3);">ğŸ”‘ Iniciar SesiÃ³n</button>
        </div>
    </div>

    <div id="action-panel">
        <!-- BOTONES NUBE (Inicialmente ocultos) -->
        <button id="btn-save-cloud" class="btn-big-action" style="background:#8e44ad; display:none;">â˜ï¸ Guardar en Nube</button>
        <button id="btn-load-cloud" class="btn-big-action" style="background:#9b59b6; display:none;">ğŸ“‚ Abrir de Nube</button>
        <div style="height:10px;"></div>
        
        <button id="btn-mobile-ar" class="btn-big-action" style="background:#2c3e50;">ğŸ“± QR Realidad Aumentada</button>
        <button id="btn-save-project" class="btn-big-action" style="background:#27ae60;">ğŸ’¾ Guardar Archivo Local</button>
        <button id="btn-load-project" class="btn-big-action" style="background:#f39c12;">ğŸ“‚ Cargar Archivo Local</button>
        <input type="file" id="project-upload" style="display: none;" accept=".json">
        <div style="height:10px;"></div>
        <button id="btn-screenshot" class="btn-big-action">ğŸ“· Foto</button>
        <button id="btn-export-pdf" class="btn-big-action">ğŸ“„ Exportar Dossier</button>
        <button id="btn-export-dxf" class="btn-big-action" style="background:#0984e3;">ğŸ“ Exportar CAD (.dxf)</button>
        <button id="btn-export-glb" class="btn-big-action" style="background:#e67e22;">ğŸ“¦ Exportar 3D (.glb)</button>
    </div>

    <!-- ... (El resto de paneles UI se mantiene igual: env-panel, floor-input-panel, ui-panel, edit-panel) ... -->
    <div id="env-panel">
        <h1>Ambiente / Cielo</h1>
        <p class="panel-subtitle">Presets</p>
        <div class="bg-options">
            <button class="bg-btn" id="env-white" style="background: #ffffff; color:#333; font-weight:bold; font-size:10px;">BLANCO</button>
            <button class="bg-btn" id="env-morning" style="background: linear-gradient(to right, #87CEEB, #FFD700);">MaÃ±ana</button>
            <button class="bg-btn" id="env-noon" style="background: linear-gradient(to right, #00BFFF, #FFFFFF);">MediodÃ­a</button>
            <button class="bg-btn" id="env-evening" style="background: linear-gradient(to right, #FF4500, #8A2BE2);">Tarde</button>
        </div>
        <p class="panel-subtitle">PosiciÃ³n Sol</p>
        <input type="range" min="0" max="360" value="45" id="sun-azimuth">
        <input type="range" min="0" max="90" value="45" id="sun-elevation">
        <p class="panel-subtitle">Intensidad Luz</p>
        <input type="range" min="0" max="3" step="0.1" value="1.5" id="light-intensity">
    </div>

    <div id="floor-input-panel">
        <h1 style="justify-content:center">âœï¸ Dibujando Suelo</h1>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button id="mode-poly" class="btn-mini active-mode" style="background:#4a90e2; color:white;">PolÃ­gono</button>
            <button id="mode-rect" class="btn-mini">RectÃ¡ngulo</button>
        </div>
        <div id="poly-inputs">
            <p style="font-size:11px; color:#aaa; margin-top:-5px">Escribe para fijar medidas</p>
            <div class="input-row">
                <div style="flex:1">
                    <span class="input-label">Distancia (m)</span>
                    <input type="number" id="inp-dist" class="input-box" step="0.5" placeholder="RatÃ³n...">
                </div>
                <div style="flex:1">
                    <span class="input-label">Ãngulo (Âº)</span>
                    <input type="number" id="inp-ang" class="input-box" step="15" placeholder="RatÃ³n...">
                </div>
            </div>
            <button id="btn-add-point">â• AÃ±adir Punto</button>
        </div>
        <div id="rect-inputs" style="display:none; text-align:center; padding:10px; color:#aaa; font-size:12px;">
            Haz click y arrastra en el suelo para crear un rectÃ¡ngulo.
        </div>
        <div id="fence-options-panel" style="display:none; margin-top:10px; border-top:1px solid #555; padding-top:10px; text-align:left;">
            <p class="panel-subtitle">Modelo de Valla</p>
            <select id="fence-model-select" class="input-box" style="margin-bottom:10px;">
                <option value="wood">Madera ClÃ¡sica</option>
                <option value="metal_slats">MetÃ¡lica Lamas</option>
                <option value="wide_panel">Paneles Anchos</option>
                <option value="game_panel">Panel de Juego</option>
            </select>
            <p class="panel-subtitle">Colores</p>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <div style="flex:1">
                    <span class="input-label">Poste</span>
                    <input type="color" id="fence-col-post" value="#5d4037" style="width:100%; height:25px; border:none; padding:0;">
                </div>
                <div style="flex:1">
                    <span class="input-label">Lama 1</span>
                    <input type="color" id="fence-col-a" value="#8d6e63" style="width:100%; height:25px; border:none; padding:0;">
                </div>
            </div>
            <div style="display:flex; gap:5px;">
                <div style="flex:1">
                    <span class="input-label">Lama 2</span>
                    <input type="color" id="fence-col-b" value="#f1c40f" style="width:100%; height:25px; border:none; padding:0;">
                </div>
                <div style="flex:1">
                    <span class="input-label">Lama 3</span>
                    <input type="color" id="fence-col-c" value="#3498db" style="width:100%; height:25px; border:none; padding:0;">
                </div>
            </div>
        </div>
        <button id="btn-close-floor" class="btn-finish-floor">âœ… Terminar</button>
    </div>

    <div id="ui-panel">
        <h1>-----_LEVIPARK21 Playgrounds <button class="panel-header-btn" id="btn-close-menu">Ã—</button></h1>
        <button class="projection-toggle" id="btn-projection">ğŸ‘ï¸ Perspectiva</button>
        <div class="views-grid">
            <button class="btn-view" id="view-iso">ğŸ“¦ Iso</button>
            <button class="btn-view" id="view-top">ğŸ“ Planta</button>
            <button class="btn-view" id="view-front">ğŸ“ Alzado</button>
            <button class="btn-view" id="view-side">ğŸ¥´ Perfil</button>
        </div>
        <div class="tools-grid">
            <button id="btn-measure" class="btn-tool">ğŸ“ Medir</button>
            <button id="btn-floor" class="btn-tool">âœï¸ Suelo</button>
            <button id="btn-fence" class="btn-tool" style="background:#5d4037;">ğŸš§ Valla</button>
        </div>
        <button id="btn-upload-trigger" class="btn-view" style="width:100%; margin-bottom:15px; background:#4a90e2; border:none; color:white; font-weight:bold; padding:10px; cursor:pointer;">ğŸ“‚ Subir Modelo 3D</button>
        <input type="file" id="file-upload" style="display: none;" accept=".glb,.gltf,.jpg,.jpeg,.png">
        <button id="clear-measures" class="btn-view" style="width:100%; margin-bottom:10px; display:none; background:#d9534f; border:none;">ğŸ—‘ï¸ Borrar Medidas</button>
        <input type="text" id="catalog-search" class="input-box" placeholder="ğŸ” Buscar producto..." style="margin-bottom:10px;">
        <h2>CatÃ¡logo</h2>
        <select id="line-select" class="line-selector"></select>
        <div id="dynamic-catalog"></div>
        
        <!-- CAJA DE PRESUPUESTO ACTUALIZADA -->
        <div id="budget-box" style="margin-top:15px; border-top:1px solid #555; padding-top:10px; font-size:20px; font-weight:bold; color:#4cd137; text-align:right;">0 â‚¬</div>
        <div id="discount-display" style="text-align:right; font-size:12px; color:#f1c40f; display:none;"></div>
        
        <button id="btn-show-list" class="btn-view" style="width:100%; margin-top:5px; background:#34495e; border:none; color:white;">ğŸ“‹ Ver Lista de Elementos</button>
        <button id="btn-reset" class="btn-reset">âŒ Borrar Todo</button>
    </div>

    <div id="edit-panel">
        <h1>Editar <button class="panel-header-btn" id="btn-min-edit">_</button></h1>
        <div id="edit-content">
            <button id="btn-lock" class="status-btn">ğŸ”“ Fijar</button>
            <button id="btn-collision" class="status-btn edit-control">ğŸ’¥ ColisiÃ³n: ON</button>
            <button id="btn-clone" class="status-btn" style="background: #8e44ad; color:white; margin-top:5px;">ğŸ‘ Duplicar</button>
            
            <div id="gizmo-controls" style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">
                <p class="panel-subtitle">Modo de EdiciÃ³n</p>
                <div class="control-row">
                    <button class="btn-mini active-mode" id="mode-translate" style="background:#4a90e2; color:white;" title="Mover (T)">â¬Œ Mover</button>
                    <button class="btn-mini" id="mode-rotate" title="Rotar (R)">â†» Rotar</button>
                    <button class="btn-mini" id="mode-scale" title="Escalar (E)">â¤¢ Escalar</button>
                </div>
            </div>
            
            <div id="edit-floor-specific" style="display:none; margin-top:15px; border-top:1px solid #555; padding-top:10px;">
                <h2>DiseÃ±o Suelo</h2>
                <button id="btn-floor-upload-tex" class="btn-action" style="background:#e67e22; margin-bottom:10px;">ğŸ–¼ï¸ Cargar Imagen PNG</button>
                <div class="floor-colors-grid">
                    <button class="f-col-btn f-garnet" id="fc-garnet" title="Granate"></button>
                    <button class="f-col-btn f-blue" id="fc-blue" title="Azul"></button>
                    <button class="f-col-btn f-green" id="fc-green" title="Verde"></button>
                    <button class="f-col-btn f-black" id="fc-black" title="Negro"></button>
                </div>
                <div id="texture-mapping-controls" style="display:none; margin-top:10px; border-top:1px solid #444; padding-top:5px;">
                    <p class="panel-subtitle">Ajustar Imagen</p>
                    <div style="margin-bottom:5px;">
                        <span class="input-label">Escala</span>
                        <input type="range" id="tex-scale" min="0.1" max="5" step="0.1" value="1" style="width:100%">
                    </div>
                    <div style="margin-bottom:5px;">
                        <span class="input-label">RotaciÃ³n</span>
                        <input type="range" id="tex-rotate" min="0" max="6.28" step="0.1" value="0" style="width:100%">
                    </div>
                    <div class="input-row">
                        <div style="flex:1">
                            <span class="input-label">Pos X</span>
                            <input type="number" id="tex-off-x" class="input-box" step="0.1" value="0">
                        </div>
                        <div style="flex:1">
                            <span class="input-label">Pos Y</span>
                            <input type="number" id="tex-off-y" class="input-box" step="0.1" value="0">
                        </div>
                    </div>
                </div>
                <p style="font-size:10px; color:#aaa; margin-top:10px; text-align:center;">
                    Valor Suelo: <span style="color:#fff; font-weight:bold;" id="floor-price-display">--</span> â‚¬
                </p>
            </div>
            <button class="btn-action btn-delete edit-control" id="btn-delete" style="margin-top:15px">ğŸ—‘ï¸ Eliminar</button>
        </div>
    </div>
    <div id="list-modal" class="modal-overlay">
        <div class="modal-box" style="width: 400px; max-width:90%; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ“‹ Lista de Proyecto</h3>
                <button onclick="document.getElementById('list-modal').style.display='none'" style="background:none; border:none; color:#aaa; font-size:20px; cursor:pointer;">Ã—</button>
            </div>
            <div id="list-content" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;"></div>
            <div style="text-align:right; border-top:1px solid #444; padding-top:10px;">
                Total: <span id="list-total-price" style="font-weight:bold; color:#4cd137;">0 â‚¬</span>
            </div>
        </div>
    </div>
    <script type="module" src="main.js"></script>
</body>
</html>